<div class="banner-slider">
    <div class="banner-slider__container">
        <div class="banner-slider__slides" id="bannerSliderSlides">
            {banner_slides}
        </div>
        <div class="banner-slider__navigation" id="bannerSliderNavigation">
            {banner_navigation}
        </div>
    </div>
</div>

<script>
(function() {
    console.log('Banner Slider: Initializing...');
    
    const slides = document.querySelectorAll('.banner-slide');
    const navItems = document.querySelectorAll('.banner-slider__nav-item');
    
    console.log(`Banner Slider: Found ${slides.length} slides and ${navItems.length} navigation items`);
    
    // Debug: Log each slide found
    slides.forEach((slide, index) => {
        const title = slide.querySelector('.banner-slide__title h2');
        console.log(`Banner Slider: Slide ${index + 1} - Title: ${title ? title.textContent : 'No title found'}`);
    });
    
    if (slides.length === 0) {
        console.warn('Banner Slider: No slides found, exiting');
        return;
    }
    
    if (slides.length !== navItems.length) {
        console.error(`Banner Slider: Mismatch between slides (${slides.length}) and navigation items (${navItems.length})`);
    }
    
    let currentSlide = 0;
    let autoAdvanceTimer = null;
    let isTransitioning = false;
    let progressAnimationFrame = null;
    let progressStartTime = null;
    let progressDuration = 8888; // 8.888 seconds

    // Mobile detection
    function isMobile() {
        return window.innerWidth <= 768;
    }
    
    // Update slide behavior for responsive design
    function updateSlideHeights() {
        if (!isMobile()) {
            slides.forEach(slide => {
                slide.style.position = '';
                slide.style.height = '';
                slide.style.display = '';
            });
        }
    }
    
    // Initialize first slide
    console.log('Banner Slider: Showing initial slide');
    
    // Verify all slides are in the DOM
    const slideContainer = document.getElementById('bannerSliderSlides');
    if (slideContainer) {
        const allSlides = slideContainer.querySelectorAll('.banner-slide');
        console.log(`Banner Slider: Container has ${allSlides.length} slides total`);
    }
    
    // Initialize responsive behavior
    updateSlideHeights();
    showSlide(0);
    
    // Handle window resize
    let resizeTimeout;
    window.addEventListener('resize', () => {
        clearTimeout(resizeTimeout);
        resizeTimeout = setTimeout(() => {
            updateSlideHeights();
            // Ensure current slide is properly displayed after resize
            showSlide(currentSlide);
        }, 100);
    });
    
    // Add click handlers to navigation items with debouncing
    navItems.forEach((navItem, index) => {
        navItem.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            
            if (isTransitioning) {
                console.log('Banner Slider: Ignoring click during transition');
                return;
            }
            
            console.log(`Banner Slider: Navigation clicked for slide ${index}`);
            showSlide(index);
        });
    });

    function showSlide(index) {
        if (index < 0 || index >= slides.length) {
            console.error(`Banner Slider: Invalid slide index ${index}, max is ${slides.length - 1}`);
            return;
        }

        if (isTransitioning && index !== currentSlide) {
            console.log('Banner Slider: Ignoring showSlide during transition');
            return;
        }
        
        console.log(`Banner Slider: Transitioning to slide ${index}`);
        isTransitioning = true;

        clearAutoAdvanceTimer();
        cancelProgressAnimation();

        navItems.forEach((item, i) => {
            item.classList.remove('active');
            const progress = item.querySelector('.banner-slider__nav-progress');
            if (progress) {
                progress.style.transition = 'none';
                progress.style.width = '0%';
                progress.offsetHeight;
            }
        });
        
        // Hide all slides
        slides.forEach((slide, i) => {
            slide.classList.remove('active');
        });
        
        // Small delay to ensure DOM updates are processed
        requestAnimationFrame(() => {
            if (slides[index]) {
                slides[index].classList.add('active');
                console.log(`Banner Slider: Activated slide ${index}`);
            }
            
            if (navItems[index]) {
                navItems[index].classList.add('active');
                console.log(`Banner Slider: Activated navigation item ${index}`);
                
                // Start progress bar animation with proper timing
                const progress = navItems[index].querySelector('.banner-slider__nav-progress');
                if (progress) {
                    // Reset progress bar
                    progress.style.transition = 'none';
                    progress.style.width = '0%';
                    
                    // Force a reflow to ensure the reset is applied
                    progress.offsetWidth;
                    
                    // Record start time for progress tracking
                    progressStartTime = Date.now();
                    
                    // Start the animation after a small delay to ensure DOM is ready
                    requestAnimationFrame(() => {
                        if (currentSlide === index && !document.hidden) { // Double-check we're still on the same slide and page is visible
                            progress.style.transition = `width ${progressDuration}ms linear`;
                            progress.style.width = '100%';
                            console.log(`Banner Slider: Started progress animation for slide ${index}`);
                        }
                    });
                }
            }
            
            currentSlide = index;
            
            // Update slide heights for mobile layout
            updateSlideHeights();
            
            isTransitioning = false;
            
            // Setup auto advance
            scheduleAutoAdvance();
        });
    }
    
    function scheduleAutoAdvance() {
        clearAutoAdvanceTimer();
        autoAdvanceTimer = setTimeout(() => {
            if (!isTransitioning) {
                const nextSlide = (currentSlide + 1) % slides.length;
                console.log(`Banner Slider: Auto-advancing from slide ${currentSlide} to ${nextSlide}`);
                showSlide(nextSlide);
            }
        }, progressDuration);
    }
    
    function clearAutoAdvanceTimer() {
        if (autoAdvanceTimer) {
            clearTimeout(autoAdvanceTimer);
            autoAdvanceTimer = null;
        }
    }
    
    function cancelProgressAnimation() {
        if (progressAnimationFrame) {
            cancelAnimationFrame(progressAnimationFrame);
            progressAnimationFrame = null;
        }
    }
    
    // Handle visibility changes to pause when tab is not active
    document.addEventListener('visibilitychange', () => {
        if (document.hidden) {
            console.log('Banner Slider: Page hidden, pausing');
            clearAutoAdvanceTimer();
            
            // Pause the progress bar animation
            const activeNavItem = document.querySelector('.banner-slider__nav-item.active');
            if (activeNavItem) {
                const progress = activeNavItem.querySelector('.banner-slider__nav-progress');
                if (progress && progressStartTime) {
                    // Calculate how much progress has been made
                    const elapsed = Date.now() - progressStartTime;
                    const progressPercent = Math.min((elapsed / progressDuration) * 100, 100);
                    
                    // Stop the animation and set current progress
                    progress.style.transition = 'none';
                    progress.style.width = progressPercent + '%';
                    
                    console.log(`Banner Slider: Paused progress at ${progressPercent.toFixed(1)}%`);
                }
            }
        } else {
            console.log('Banner Slider: Page visible, resuming');

            const activeNavItem = document.querySelector('.banner-slider__nav-item.active');
            if (activeNavItem && progressStartTime) {
                const progress = activeNavItem.querySelector('.banner-slider__nav-progress');
                if (progress) {
                    const elapsed = Date.now() - progressStartTime;
                    const remaining = Math.max(progressDuration - elapsed, 0);
                    
                    if (remaining > 0) {
                        // Resume the progress bar animation
                        progress.style.transition = `width ${remaining}ms linear`;
                        progress.style.width = '100%';
                        
                        console.log(`Banner Slider: Resumed progress with ${remaining}ms remaining`);
                        
                        // Schedule auto advance for remaining time
                        clearAutoAdvanceTimer();
                        autoAdvanceTimer = setTimeout(() => {
                            if (!isTransitioning) {
                                const nextSlide = (currentSlide + 1) % slides.length;
                                console.log(`Banner Slider: Auto-advancing from slide ${currentSlide} to ${nextSlide}`);
                                showSlide(nextSlide);
                            }
                        }, remaining);
                    } else {
                        // Time already elapsed, advance immediately
                        console.log('Banner Slider: Time elapsed while hidden, advancing now');
                        const nextSlide = (currentSlide + 1) % slides.length;
                        showSlide(nextSlide);
                    }
                }
            } else {
                // No active progress tracking, just resume normal timing
                scheduleAutoAdvance();
            }
        }
    });
    
    console.log('Banner Slider: Initialization complete');
})();
</script>
